"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ImageElement = exports.IMAGE_EL_TAP_STRATEGY_W3C = exports.IMAGE_EL_TAP_STRATEGY_MJSONWP = exports.DEFAULT_TEMPLATE_IMAGE_SCALE = void 0;
exports.getImgElFromArgs = getImgElFromArgs;
exports.makeImageElementCache = makeImageElementCache;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../..");

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _constants = require("../constants");

var _logger = _interopRequireDefault(require("./logger"));

var _appiumSupport = require("appium-support");

const MAX_CACHE_SIZE = 1024 * 1024 * 40;
const TAP_DURATION_MS = 125;
const IMAGE_EL_TAP_STRATEGY_W3C = 'w3cActions';
exports.IMAGE_EL_TAP_STRATEGY_W3C = IMAGE_EL_TAP_STRATEGY_W3C;
const IMAGE_EL_TAP_STRATEGY_MJSONWP = 'touchActions';
exports.IMAGE_EL_TAP_STRATEGY_MJSONWP = IMAGE_EL_TAP_STRATEGY_MJSONWP;
const IMAGE_TAP_STRATEGIES = [IMAGE_EL_TAP_STRATEGY_MJSONWP, IMAGE_EL_TAP_STRATEGY_W3C];
const DEFAULT_TEMPLATE_IMAGE_SCALE = 1.0;
exports.DEFAULT_TEMPLATE_IMAGE_SCALE = DEFAULT_TEMPLATE_IMAGE_SCALE;

class ImageElement {
  constructor(b64Template, rect, score, b64Result = null) {
    this.template = b64Template;
    this.rect = rect;
    this.id = `${_constants.IMAGE_ELEMENT_PREFIX}${_appiumSupport.util.uuidV4()}`;
    this.b64MatchedImage = b64Result;
    this.score = score;
  }

  get size() {
    return {
      width: this.rect.width,
      height: this.rect.height
    };
  }

  get location() {
    return {
      x: this.rect.x,
      y: this.rect.y
    };
  }

  get center() {
    return {
      x: this.rect.x + this.rect.width / 2,
      y: this.rect.y + this.rect.height / 2
    };
  }

  get matchedImage() {
    return this.b64MatchedImage;
  }

  asElement(protocolKey) {
    return {
      [protocolKey]: this.id
    };
  }

  equals(other) {
    return this.rect.x === other.rect.x && this.rect.y === other.rect.y && this.rect.width === other.rect.width && this.rect.height === other.rect.height;
  }

  async click(driver) {
    let newImgEl;
    const {
      autoUpdateImageElementPosition: updatePos,
      checkForImageElementStaleness,
      imageElementTapStrategy
    } = driver.settings.getSettings();

    if (!IMAGE_TAP_STRATEGIES.includes(imageElementTapStrategy)) {
      throw new Error(`Incorrect imageElementTapStrategy setting ` + `'${imageElementTapStrategy}'. Must be one of ` + JSON.stringify(IMAGE_TAP_STRATEGIES));
    }

    if (checkForImageElementStaleness || updatePos) {
      _logger.default.info('Checking image element for staleness before clicking');

      try {
        newImgEl = await driver.findByImage(this.template, {
          shouldCheckStaleness: true,
          ignoreDefaultImageTemplateScale: true
        });
      } catch (err) {
        throw new _2.errors.StaleElementReferenceError();
      }

      if (!this.equals(newImgEl)) {
        _logger.default.warn(`When trying to click on an image element, the image changed ` + `position from where it was originally found. It is now at ` + `${JSON.stringify(newImgEl.rect)} and was originally at ` + `${JSON.stringify(this.rect)}.`);

        if (updatePos) {
          _logger.default.warn('Click will proceed at new coordinates');

          this.rect = _lodash.default.clone(newImgEl.rect);
        } else {
          _logger.default.warn('Click will take place at original coordinates. If you ' + 'would like Appium to automatically click the new ' + "coordinates, set the 'autoUpdateImageElementPosition' " + 'setting to true');
        }
      }
    }

    const {
      x,
      y
    } = this.center;

    _logger.default.info(`Will tap on image element at coordinate [${x}, ${y}]`);

    if (imageElementTapStrategy === IMAGE_EL_TAP_STRATEGY_W3C) {
      _logger.default.info('Will tap using W3C actions');

      const action = {
        type: 'pointer',
        id: 'mouse',
        parameters: {
          pointerType: 'touch'
        },
        actions: [{
          type: 'pointerMove',
          x,
          y,
          duration: 0
        }, {
          type: 'pointerDown',
          button: 0
        }, {
          type: 'pause',
          duration: TAP_DURATION_MS
        }, {
          type: 'pointerUp',
          button: 0
        }]
      };

      if (driver.performActions) {
        return await driver.performActions([action]);
      }

      _logger.default.warn('Driver does not seem to implement W3C actions, falling back ' + 'to TouchActions');
    }

    _logger.default.info('Will tap using MJSONWP TouchActions');

    const action = {
      action: 'tap',
      options: {
        x,
        y
      }
    };

    if (driver.performTouch) {
      return await driver.performTouch([action]);
    }

    throw new Error("Driver did not implement the 'performTouch' command. " + 'For drivers to support finding image elements, they ' + "should support 'performTouch' and 'performActions'");
  }

  static async execute(driver, cmd, imgElId, ...args) {
    if (!driver._imgElCache.has(imgElId)) {
      throw new _2.errors.NoSuchElementError();
    }

    const imgEl = driver._imgElCache.get(imgElId);

    switch (cmd) {
      case 'click':
        return await imgEl.click(driver);

      case 'elementDisplayed':
        return true;

      case 'getSize':
        return imgEl.size;

      case 'getLocation':
      case 'getLocationInView':
        return imgEl.location;

      case 'getElementRect':
        return imgEl.rect;

      case 'getAttribute':
        switch (args[0]) {
          case 'visual':
            return imgEl.matchedImage;

          case 'score':
            return imgEl.score;

          default:
            throw new _2.errors.NotYetImplementedError();
        }

      default:
        throw new _2.errors.NotYetImplementedError();
    }
  }

}

exports.ImageElement = ImageElement;

function makeImageElementCache(max = MAX_CACHE_SIZE) {
  return new _lruCache.default({
    max,
    length: el => el.template.length
  });
}

function getImgElFromArgs(args) {
  for (let arg of args) {
    if (_lodash.default.isString(arg) && arg.startsWith(_constants.IMAGE_ELEMENT_PREFIX)) {
      return arg;
    }
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2ltYWdlLWVsZW1lbnQuanMiXSwibmFtZXMiOlsiTUFYX0NBQ0hFX1NJWkUiLCJUQVBfRFVSQVRJT05fTVMiLCJJTUFHRV9FTF9UQVBfU1RSQVRFR1lfVzNDIiwiSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AiLCJJTUFHRV9UQVBfU1RSQVRFR0lFUyIsIkRFRkFVTFRfVEVNUExBVEVfSU1BR0VfU0NBTEUiLCJJbWFnZUVsZW1lbnQiLCJjb25zdHJ1Y3RvciIsImI2NFRlbXBsYXRlIiwicmVjdCIsInNjb3JlIiwiYjY0UmVzdWx0IiwidGVtcGxhdGUiLCJpZCIsIklNQUdFX0VMRU1FTlRfUFJFRklYIiwidXRpbCIsInV1aWRWNCIsImI2NE1hdGNoZWRJbWFnZSIsInNpemUiLCJ3aWR0aCIsImhlaWdodCIsImxvY2F0aW9uIiwieCIsInkiLCJjZW50ZXIiLCJtYXRjaGVkSW1hZ2UiLCJhc0VsZW1lbnQiLCJwcm90b2NvbEtleSIsImVxdWFscyIsIm90aGVyIiwiY2xpY2siLCJkcml2ZXIiLCJuZXdJbWdFbCIsImF1dG9VcGRhdGVJbWFnZUVsZW1lbnRQb3NpdGlvbiIsInVwZGF0ZVBvcyIsImNoZWNrRm9ySW1hZ2VFbGVtZW50U3RhbGVuZXNzIiwiaW1hZ2VFbGVtZW50VGFwU3RyYXRlZ3kiLCJzZXR0aW5ncyIsImdldFNldHRpbmdzIiwiaW5jbHVkZXMiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJsb2ciLCJpbmZvIiwiZmluZEJ5SW1hZ2UiLCJzaG91bGRDaGVja1N0YWxlbmVzcyIsImlnbm9yZURlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUiLCJlcnIiLCJlcnJvcnMiLCJTdGFsZUVsZW1lbnRSZWZlcmVuY2VFcnJvciIsIndhcm4iLCJfIiwiY2xvbmUiLCJhY3Rpb24iLCJ0eXBlIiwicGFyYW1ldGVycyIsInBvaW50ZXJUeXBlIiwiYWN0aW9ucyIsImR1cmF0aW9uIiwiYnV0dG9uIiwicGVyZm9ybUFjdGlvbnMiLCJvcHRpb25zIiwicGVyZm9ybVRvdWNoIiwiZXhlY3V0ZSIsImNtZCIsImltZ0VsSWQiLCJhcmdzIiwiX2ltZ0VsQ2FjaGUiLCJoYXMiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJpbWdFbCIsImdldCIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJtYWtlSW1hZ2VFbGVtZW50Q2FjaGUiLCJtYXgiLCJMUlUiLCJsZW5ndGgiLCJlbCIsImdldEltZ0VsRnJvbUFyZ3MiLCJhcmciLCJpc1N0cmluZyIsInN0YXJ0c1dpdGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxjQUFjLEdBQUcsT0FBTyxJQUFQLEdBQWMsRUFBckM7QUFDQSxNQUFNQyxlQUFlLEdBQUcsR0FBeEI7QUFDQSxNQUFNQyx5QkFBeUIsR0FBRyxZQUFsQzs7QUFDQSxNQUFNQyw2QkFBNkIsR0FBRyxjQUF0Qzs7QUFDQSxNQUFNQyxvQkFBb0IsR0FBRyxDQUMzQkQsNkJBRDJCLEVBRTNCRCx5QkFGMkIsQ0FBN0I7QUFJQSxNQUFNRyw0QkFBNEIsR0FBRyxHQUFyQzs7O0FBMEJBLE1BQU1DLFlBQU4sQ0FBbUI7QUFhakJDLEVBQUFBLFdBQVcsQ0FBRUMsV0FBRixFQUFlQyxJQUFmLEVBQXFCQyxLQUFyQixFQUE0QkMsU0FBUyxHQUFHLElBQXhDLEVBQThDO0FBQ3ZELFNBQUtDLFFBQUwsR0FBZ0JKLFdBQWhCO0FBQ0EsU0FBS0MsSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS0ksRUFBTCxHQUFXLEdBQUVDLCtCQUFxQixHQUFFQyxvQkFBS0MsTUFBTCxFQUFjLEVBQWxEO0FBQ0EsU0FBS0MsZUFBTCxHQUF1Qk4sU0FBdkI7QUFDQSxTQUFLRCxLQUFMLEdBQWFBLEtBQWI7QUFDRDs7QUFLTyxNQUFKUSxJQUFJLEdBQUk7QUFDVixXQUFPO0FBQUNDLE1BQUFBLEtBQUssRUFBRSxLQUFLVixJQUFMLENBQVVVLEtBQWxCO0FBQXlCQyxNQUFBQSxNQUFNLEVB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ZUFBSyxPQUFMO0FBQ0UsbUJBQU84QyxLQUFLLENBQUM3RCxLQUFiOztBQUNGO0FBQ0Usa0JBQU0sSUFBSXVDLFVBQU93QixzQkFBWCxFQUFOO0FBTko7O0FBUUY7QUFBUyxjQUFNLElBQUl4QixVQUFPd0Isc0JBQVgsRUFBTjtBQXhCWDtBQTBCRDs7QUF4TmdCOzs7O0FBMk5uQixTQUFTQyxxQkFBVCxDQUFnQ0MsR0FBRyxHQUFHM0UsY0FBdEMsRUFBc0Q7QUFDcEQsU0FBTyxJQUFJNEUsaUJBQUosQ0FBUTtBQUNiRCxJQUFBQSxHQURhO0FBRWJFLElBQUFBLE1BQU0sRUFBR0MsRUFBRCxJQUFRQSxFQUFFLENBQUNsRSxRQUFILENBQVlpRTtBQUZmLEdBQVIsQ0FBUDtBQUlEOztBQUVELFNBQVNFLGdCQUFULENBQTJCWixJQUEzQixFQUFpQztBQUMvQixPQUFLLElBQUlhLEdBQVQsSUFBZ0JiLElBQWhCLEVBQXNCO0FBQ3BCLFFBQUlmLGdCQUFFNkIsUUFBRixDQUFXRCxHQUFYLEtBQW1CQSxHQUFHLENBQUNFLFVBQUosQ0FBZXBFLCtCQUFmLENBQXZCLEVBQTZEO0FBQzNELGFBQU9rRSxHQUFQO0FBQ0Q7QUFDRjtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJy4uLy4uJztcbmltcG9ydCBMUlUgZnJvbSAnbHJ1LWNhY2hlJztcbmltcG9ydCB7IElNQUdFX0VMRU1FTlRfUFJFRklYIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuY29uc3QgTUFYX0NBQ0hFX1NJWkUgPSAxMDI0ICogMTAyNCAqIDQwOyAvLyA0MG1iXG5jb25zdCBUQVBfRFVSQVRJT05fTVMgPSAxMjU7XG5jb25zdCBJTUFHRV9FTF9UQVBfU1RSQVRFR1lfVzNDID0gJ3czY0FjdGlvbnMnO1xuY29uc3QgSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AgPSAndG91Y2hBY3Rpb25zJztcbmNvbnN0IElNQUdFX1RBUF9TVFJBVEVHSUVTID0gW1xuICBJTUFHRV9FTF9UQVBfU1RSQVRFR1lfTUpTT05XUCxcbiAgSU1BR0VfRUxfVEFQX1NUUkFURUdZX1czQ1xuXTtcbmNvbnN0IERFRkFVTFRfVEVNUExBVEVfSU1BR0VfU0NBTEUgPSAxLjA7XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUmVjdFxuICogQHByb3BlcnR5IHtpbnR9IHggLSB4LWNvb3JkaW5hdGUgb2YgdG9wLWxlZnQgY29ybmVyXG4gKiBAcHJvcGVydHkge2ludH0geSAtIHktY29vcmRpbmF0ZSBvZiB0b3AtbGVmdCBjb3JuZXJcbiAqIEBwcm9wZXJ0eSB7aW50fSB3aWR0aCAtIHdpZHRoIG9mIHJlY3RcbiAqIEBwcm9wZXJ0eSB7aW50fSBoZWlnaHQgLSBoZWlnaHQgb2YgcmVjdFxuICovXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gRGltZW5zaW9uXG4gKiBAcHJvcGVydHkge2ludH0gd2lkdGggLSB3aWR0aCBvZiByZWN0XG4gKiBAcHJvcGVydHkge2ludH0gaGVpZ2h0IC0gaGVpZ2h0IG9mIHJlY3RcbiAqL1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFBvc2l0aW9uXG4gKiBAcHJvcGVydHkge2ludH0geCAtIHggY29vcmRpbmF0ZVxuICogQHByb3BlcnR5IHtpbnR9IHkgLSB5IGNvb3JkaW5hdGVcbiAqL1xuXG4vKipcbiAqIFJlcHJlc2VudGF0aW9uIG9mIGFuIFwiaW1hZ2UgZWxlbWVudFwiLCB3aGljaCBpcyBzaW1wbHkgYSBzZXQgb2YgY29vcmRpbmF0ZXNcbiAqIGFuZCBtZXRob2RzIHRoYXQgY2FuIGJlIHVzZWQgb24gdGhhdCBzZXQgb2YgY29vcmRpbmF0ZXMgdmlhIHRoZSBkcml2ZXJcbiAqL1xuY2xhc3MgSW1hZ2VFbGVtZW50IHtcblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGI2NFRlbXBsYXRlIC0gdGhlIGJhc2U2NC1lbmNvZGVkIGltYWdlIHdoaWNoIHdhcyB1c2VkIHRvXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmQgdGhpcyBJbWFnZUVsZW1lbnRcbiAgICogQHBhcmFtIHtSZWN0fSByZWN0IC0gYm91bmRzIG9mIG1hdGNoZWQgaW1hZ2UgZWxlbWVudFxuICAgKiBAcGFyYW0ge251bWJlcn0gc2NvcmUgVGhlIHNpbWlsYXJpdHkgc2NvcmUgYXMgYSBmbG9hdCBudW1iZXIgaW4gcmFuZ2UgWzAuMCwgMS4wXS5cbiAgICogMS4wIGlzIHRoZSBoaWdoZXN0IHNjb3JlIChtZWFucyBib3RoIGltYWdlcyBhcmUgdG90YWxseSBlcXVhbCkuXG4gICAqIEBwYXJhbSB7P3N0cmluZ30gYjY0UmVzdWx0IC0gdGhlIGJhc2U2NC1lbmNvZGVkIGltYWdlIHdoaWNoIGhhcyBtYXRjaGVkIG1hcmtzLlxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHRzIHRvIG51bGwuXG4gICAqXG4gICAqIEByZXR1cm5zIHtJbWFnZUVsZW1lbnR9XG4gICAqL1xuICBjb25zdHJ1Y3RvciAoYjY0VGVtcGxhdGUsIHJlY3QsIHNjb3JlLCBiNjRSZXN1bHQgPSBudWxsKSB7XG4gICAgdGhpcy50ZW1wbGF0ZSA9IGI2NFRlbXBsYXRlO1xuICAgIHRoaXMucmVjdCA9IHJlY3Q7XG4gICAgdGhpcy5pZCA9IGAke0lNQUdFX0VMRU1FTlRfUFJFRklYfSR7dXRpbC51dWlkVjQoKX1gO1xuICAgIHRoaXMuYjY0TWF0Y2hlZEltYWdlID0gYjY0UmVzdWx0O1xuICAgIHRoaXMuc2NvcmUgPSBzY29yZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7RGltZW5zaW9ufSAtIGRpbWVuc2lvbiBvZiBlbGVtZW50XG4gICAqL1xuICBnZXQgc2l6ZSAoKSB7XG4gICAgcmV0dXJuIHt3aWR0aDogdGhpcy5yZWN0LndpZHRoLCBoZWlnaHQ6IHRoaXMucmVjdC5oZWlnaHR9O1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtQb3NpdGlvbn0gLSBjb29yZGluYXRlcyBvZiB0b3AtbGVmdCBjb3JuZXIgb2YgZWxlbWVudFxuICAgKi9cbiAgZ2V0IGxvY2F0aW9uICgpIHtcbiAgICByZXR1cm4ge3g6IHRoaXMucmVjdC54LCB5OiB0aGlzLnJlY3QueX07XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge1Bvc2l0aW9ufSAtIGNvb3JkaW5hdGVzIG9mIGNlbnRlciBvZiBlbGVtZW50XG4gICAqL1xuICBnZXQgY2VudGVyICgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgeDogdGhpcy5yZWN0LnggKyB0aGlzLnJlY3Qud2lkdGggLyAyLFxuICAgICAgeTogdGhpcy5yZWN0LnkgKyB0aGlzLnJlY3QuaGVpZ2h0IC8gMixcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHs/c3RyaW5nfSAtIHRoZSBiYXNlNjQtZW5jb2RlZCBpbWFnZSB3aGljaCBoYXMgbWF0Y2hlZCBtYXJrc1xuICAgKi9cbiAgZ2V0IG1hdGNoZWRJbWFnZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuYjY0TWF0Y2hlZEltYWdlO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwcm90b2NvbEtleSAtIHRoZSBwcm90b2NvbC1zcGVjaWZpYyBKU09OIGtleSBmb3JcbiAgICogYSBXZWJFbGVtZW50XG4gICAqXG4gICAqIEByZXR1cm5zIHtXZWJFbGVtZW50fSAtIHRoaXMgaW1hZ2UgZWxlbWVudCBhcyBhIFdlYkVsZW1lbnRcbiAgICovXG4gIGFzRWxlbWVudCAocHJvdG9jb2xLZXkpIHtcbiAgICByZXR1cm4ge1twcm90b2NvbEtleV06IHRoaXMuaWR9O1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7SW1hZ2VFbGVtZW50fSBvdGhlciAtIGFuIEltYWdlRWxlbWVudCB0byBjb21wYXJlIHdpdGggdGhpcyBvbmVcbiAgICpcbiAgICogQHJldHVybnMge2Jvb2xlYW59IC0gd2hldGhlciB0aGUgb3RoZXIgZWxlbWVudCBhbmQgdGhpcyBvbmUgaGF2ZSB0aGUgc2FtZVxuICAgKiBwcm9wZXJ0aWVzXG4gICAqL1xuICBlcXVhbHMgKG90aGVyKSB7XG4gICAgcmV0dXJuIHRoaXMucmVjdC54ID09PSBvdGhlci5yZWN0LnggJiZcbiAgICAgICAgICAgdGhpcy5yZWN0LnkgPT09IG90aGVyLnJlY3QueSAmJlxuICAgICAgICAgICB0aGlzLnJlY3Qud2lkdGggPT09IG90aGVyLnJlY3Qud2lkdGggJiZcbiAgICAgICAgICAgdGhpcy5yZWN0LmhlaWdodCA9PT0gb3RoZXIucmVjdC5oZWlnaHQ7XG4gIH1cblxuICAvKipcbiAgICogVXNlIGEgZHJpdmVyIHRvIHRhcCB0aGUgc2NyZWVuIGF0IHRoZSBjZW50ZXIgb2YgdGhpcyBJbWFnZUVsZW1lbnQnc1xuICAgKiBwb3NpdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge0Jhc2VEcml2ZXJ9IGRyaXZlciAtIGRyaXZlciBmb3IgY2FsbGluZyBhY3Rpb25zIHdpdGhcbiAgICovXG4gIGFzeW5jIGNsaWNrIChkcml2ZXIpIHtcbiAgICAvLyBiZWZvcmUgd2UgY2xpY2sgd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIGVsZW1lbnQgaXMgYWN0dWFsbHkgc3RpbGwgdGhlcmVcbiAgICAvLyB3aGVyZSB3ZSBleHBlY3QgaXQgdG8gYmVcbiAgICBsZXQgbmV3SW1nRWw7XG4gICAgY29uc3Qge1xuICAgICAgYXV0b1VwZGF0ZUltYWdlRWxlbWVudFBvc2l0aW9uOiB1cGRhdGVQb3MsXG4gICAgICBjaGVja0ZvckltYWdlRWxlbWVudFN0YWxlbmVzcyxcbiAgICAgIGltYWdlRWxlbWVudFRhcFN0cmF0ZWd5LFxuICAgIH0gPSBkcml2ZXIuc2V0dGluZ3MuZ2V0U2V0dGluZ3MoKTtcblxuICAgIC8vIHZhbGlkYXRlIHRhcCBzdHJhdGVneVxuICAgIGlmICghSU1BR0VfVEFQX1NUUkFURUdJRVMuaW5jbHVkZXMoaW1hZ2VFbGVtZW50VGFwU3RyYXRlZ3kpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEluY29ycmVjdCBpbWFnZUVsZW1lbnRUYXBTdHJhdGVneSBzZXR0aW5nIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAnJHtpbWFnZUVsZW1lbnRUYXBTdHJhdGVneX0nLiBNdXN0IGJlIG9uZSBvZiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShJTUFHRV9UQVBfU1RSQVRFR0lFUykpO1xuICAgIH1cblxuICAgIGlmIChjaGVja0ZvckltYWdlRWxlbWVudFN0YWxlbmVzcyB8fCB1cGRhdGVQb3MpIHtcbiAgICAgIGxvZy5pbmZvKCdDaGVja2luZyBpbWFnZSBlbGVtZW50IGZvciBzdGFsZW5lc3MgYmVmb3JlIGNsaWNraW5nJyk7XG4gICAgICB0cnkge1xuICAgICAgICBuZXdJbWdFbCA9IGF3YWl0IGRyaXZlci5maW5kQnlJbWFnZSh0aGlzLnRlbXBsYXRlLCB7XG4gICAgICAgICAgc2hvdWxkQ2hlY2tTdGFsZW5lc3M6IHRydWUsXG4gICAgICAgICAgLy8gU2V0IGlnbm9yZURlZmF1bHRJbWFnZVRlbXBsYXRlU2NhbGUgYmVjYXVzZSB0aGlzLnRlbXBsYXRlIGlzIGRldmljZSBzY3JlZW5zaG90IGJhc2VkIGltYWdlXG4gICAgICAgICAgLy8gbWFuYWdlZCBpbnNpZGUgQXBwaXVtIGFmdGVyIGZpbmlkbmcgaW1hZ2UgYnkgdGVtcGxhdGUgd2hpY2ggbWFuYWdlZCBieSBhIHVzZXJcbiAgICAgICAgICBpZ25vcmVEZWZhdWx0SW1hZ2VUZW1wbGF0ZVNjYWxlOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuU3RhbGVFbGVtZW50UmVmZXJlbmNlRXJyb3IoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCF0aGlzLmVxdWFscyhuZXdJbWdFbCkpIHtcbiAgICAgICAgbG9nLndhcm4oYFdoZW4gdHJ5aW5nIHRvIGNsaWNrIG9uIGFuIGltYWdlIGVsZW1lbnQsIHRoZSBpbWFnZSBjaGFuZ2VkIGAgK1xuICAgICAgICAgICAgICAgICBgcG9zaXRpb24gZnJvbSB3aGVyZSBpdCB3YXMgb3JpZ2luYWxseSBmb3VuZC4gSXQgaXMgbm93IGF0IGAgK1xuICAgICAgICAgICAgICAgICBgJHtKU09OLnN0cmluZ2lmeShuZXdJbWdFbC5yZWN0KX0gYW5kIHdhcyBvcmlnaW5hbGx5IGF0IGAgK1xuICAgICAgICAgICAgICAgICBgJHtKU09OLnN0cmluZ2lmeSh0aGlzLnJlY3QpfS5gKTtcbiAgICAgICAgaWYgKHVwZGF0ZVBvcykge1xuICAgICAgICAgIGxvZy53YXJuKCdDbGljayB3aWxsIHByb2NlZWQgYXQgbmV3IGNvb3JkaW5hdGVzJyk7XG4gICAgICAgICAgdGhpcy5yZWN0ID0gXy5jbG9uZShuZXdJbWdFbC5yZWN0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsb2cud2FybignQ2xpY2sgd2lsbCB0YWtlIHBsYWNlIGF0IG9yaWdpbmFsIGNvb3JkaW5hdGVzLiBJZiB5b3UgJyArXG4gICAgICAgICAgICAgICAgICAgJ3dvdWxkIGxpa2UgQXBwaXVtIHRvIGF1dG9tYXRpY2FsbHkgY2xpY2sgdGhlIG5ldyAnICtcbiAgICAgICAgICAgICAgICAgICBcImNvb3JkaW5hdGVzLCBzZXQgdGhlICdhdXRvVXBkYXRlSW1hZ2VFbGVtZW50UG9zaXRpb24nIFwiICtcbiAgICAgICAgICAgICAgICAgICAnc2V0dGluZyB0byB0cnVlJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCB7eCwgeX0gPSB0aGlzLmNlbnRlcjtcbiAgICBsb2cuaW5mbyhgV2lsbCB0YXAgb24gaW1hZ2UgZWxlbWVudCBhdCBjb29yZGluYXRlIFske3h9LCAke3l9XWApO1xuXG4gICAgaWYgKGltYWdlRWxlbWVudFRhcFN0cmF0ZWd5ID09PSBJTUFHRV9FTF9UQVBfU1RSQVRFR1lfVzNDKSB7XG4gICAgICAvLyBzZXQgdXAgYSBXM0MgYWN0aW9uIHRvIGNsaWNrIG9uIHRoZSBpbWFnZSBieSBwb3NpdGlvblxuICAgICAgbG9nLmluZm8oJ1dpbGwgdGFwIHVzaW5nIFczQyBhY3Rpb25zJyk7XG4gICAgICBjb25zdCBhY3Rpb24gPSB7XG4gICAgICAgIHR5cGU6ICdwb2ludGVyJyxcbiAgICAgICAgaWQ6ICdtb3VzZScsXG4gICAgICAgIHBhcmFtZXRlcnM6IHtwb2ludGVyVHlwZTogJ3RvdWNoJ30sXG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICB7dHlwZTogJ3BvaW50ZXJNb3ZlJywgeCwgeSwgZHVyYXRpb246IDB9LFxuICAgICAgICAgIHt0eXBlOiAncG9pbnRlckRvd24nLCBidXR0b246IDB9LFxuICAgICAgICAgIHt0eXBlOiAncGF1c2UnLCBkdXJhdGlvbjogVEFQX0RVUkFUSU9OX01TfSxcbiAgICAgICAgICB7dHlwZTogJ3BvaW50ZXJVcCcsIGJ1dHRvbjogMH0sXG4gICAgICAgIF1cbiAgICAgIH07XG5cbiAgICAgIC8vIGNoZWNrIGlmIHRoZSBkcml2ZXIgaGFzIHRoZSBhcHByb3ByaWF0ZSBwZXJmb3JtQWN0aW9ucyBtZXRob2RcbiAgICAgIGlmIChkcml2ZXIucGVyZm9ybUFjdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IGRyaXZlci5wZXJmb3JtQWN0aW9ucyhbYWN0aW9uXSk7XG4gICAgICB9XG5cbiAgICAgIC8vIGlmIG5vdCwgd2FybiBhbmQgZmFsbCBiYWNrIHRvIHRoZSBvdGhlciBtZXRob2RcbiAgICAgIGxvZy53YXJuKCdEcml2ZXIgZG9lcyBub3Qgc2VlbSB0byBpbXBsZW1lbnQgVzNDIGFjdGlvbnMsIGZhbGxpbmcgYmFjayAnICtcbiAgICAgICAgICAgICAgICd0byBUb3VjaEFjdGlvbnMnKTtcbiAgICB9XG5cbiAgICAvLyBpZiB0aGUgdzNjIHN0cmF0ZWd5IHdhcyBub3QgcmVxdWVzdGVkLCBkbyB0aGUgb25seSBvdGhlciBvcHRpb24gKG1qc29ud3BcbiAgICAvLyB0b3VjaCBhY3Rpb25zKVxuICAgIGxvZy5pbmZvKCdXaWxsIHRhcCB1c2luZyBNSlNPTldQIFRvdWNoQWN0aW9ucycpO1xuICAgIGNvbnN0IGFjdGlvbiA9IHtcbiAgICAgIGFjdGlvbjogJ3RhcCcsXG4gICAgICBvcHRpb25zOiB7eCwgeX1cbiAgICB9O1xuXG4gICAgaWYgKGRyaXZlci5wZXJmb3JtVG91Y2gpIHtcbiAgICAgIHJldHVybiBhd2FpdCBkcml2ZXIucGVyZm9ybVRvdWNoKFthY3Rpb25dKTtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJEcml2ZXIgZGlkIG5vdCBpbXBsZW1lbnQgdGhlICdwZXJmb3JtVG91Y2gnIGNvbW1hbmQuIFwiICtcbiAgICAgICAgICAgICAgICAgICAgJ0ZvciBkcml2ZXJzIHRvIHN1cHBvcnQgZmluZGluZyBpbWFnZSBlbGVtZW50cywgdGhleSAnICtcbiAgICAgICAgICAgICAgICAgICAgXCJzaG91bGQgc3VwcG9ydCAncGVyZm9ybVRvdWNoJyBhbmQgJ3BlcmZvcm1BY3Rpb25zJ1wiKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGUgdmFyaW91cyBBcHBpdW0gY29tbWFuZHMgdGhhdCBpbnZvbHZlIGFuIGltYWdlIGVsZW1lbnRcbiAgICpcbiAgICogQHBhcmFtIHtCYXNlRHJpdmVyfSBkcml2ZXIgLSB0aGUgZHJpdmVyIHRvIHVzZSBmb3IgY29tbWFuZHNcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNtZCAtIHRoZSBuYW1lIG9mIHRoZSBkcml2ZXIgY29tbWFuZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gaW1nRWxJZCAtIHRoZSBpZCBvZiB0aGUgSW1hZ2VFbGVtZW50IHRvIHdvcmsgd2l0aFxuICAgKiBAcGFyYW0ge0FycmF5fSBhcmdzIC0gUmVzdCBvZiBhcmd1bWVudHMgZm9yIGV4ZWN1dGVTY3JpcHRzXG4gICAqXG4gICAqIEByZXR1cm5zIHtPYmplY3R9IC0gdGhlIHJlc3VsdCBvZiBydW5uaW5nIGEgY29tbWFuZFxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGV4ZWN1dGUgKGRyaXZlciwgY21kLCBpbWdFbElkLCAuLi5hcmdzKSB7XG4gICAgaWYgKCFkcml2ZXIuX2ltZ0VsQ2FjaGUuaGFzKGltZ0VsSWQpKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICAgIH1cblxuICAgIGNvbnN0IGltZ0VsID0gZHJpdmVyLl9pbWdFbENhY2hlLmdldChpbWdFbElkKTtcblxuICAgIHN3aXRjaCAoY21kKSB7XG4gICAgICBjYXNlICdjbGljayc6XG4gICAgICAgIHJldHVybiBhd2FpdCBpbWdFbC5jbGljayhkcml2ZXIpO1xuICAgICAgY2FzZSAnZWxlbWVudERpc3BsYXllZCc6XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgY2FzZSAnZ2V0U2l6ZSc6XG4gICAgICAgIHJldHVybiBpbWdFbC5zaXplO1xuICAgICAgY2FzZSAnZ2V0TG9jYXRpb24nOlxuICAgICAgY2FzZSAnZ2V0TG9jYXRpb25JblZpZXcnOlxuICAgICAgICByZXR1cm4gaW1nRWwubG9jYXRpb247XG4gICAgICBjYXNlICdnZXRFbGVtZW50UmVjdCc6XG4gICAgICAgIHJldHVybiBpbWdFbC5yZWN0O1xuICAgICAgY2FzZSAnZ2V0QXR0cmlidXRlJzpcbiAgICAgICAgLy8gL3Nlc3Npb24vOnNlc3Npb25JZC9lbGVtZW50LzplbGVtZW50SWQvYXR0cmlidXRlLzpuYW1lXG4gICAgICAgIC8vIC9zZXNzaW9uLzpzZXNzaW9uSWQvZWxlbWVudC86ZWxlbWVudElkL2F0dHJpYnV0ZS92aXN1YWwgc2hvdWxkIHJldHVuIHRoZSB2aXN1YWwgZGF0YVxuICAgICAgICAvLyBlLmcuIFtcImNvbnRlbnQtZGVzY1wiLFwiYXBwaXVtLWltYWdlLWVsZW1lbnQteHh4eHhcIixcInh4eHh4XCJdLCBbXCJ2aXN1YWxcIixcImFwcGl1bS1pbWFnZS1lbGVtZW50LXh4eHh4XCIsXCJ4eHh4eFwiXVxuICAgICAgICBzd2l0Y2ggKGFyZ3NbMF0pIHtcbiAgICAgICAgICBjYXNlICd2aXN1YWwnOlxuICAgICAgICAgICAgcmV0dXJuIGltZ0VsLm1hdGNoZWRJbWFnZTtcbiAgICAgICAgICBjYXNlICdzY29yZSc6XG4gICAgICAgICAgICByZXR1cm4gaW1nRWwuc2NvcmU7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICAgICAgICB9XG4gICAgICBkZWZhdWx0OiB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gbWFrZUltYWdlRWxlbWVudENhY2hlIChtYXggPSBNQVhfQ0FDSEVfU0laRSkge1xuICByZXR1cm4gbmV3IExSVSh7XG4gICAgbWF4LFxuICAgIGxlbmd0aDogKGVsKSA9PiBlbC50ZW1wbGF0ZS5sZW5ndGgsXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBnZXRJbWdFbEZyb21BcmdzIChhcmdzKSB7XG4gIGZvciAobGV0IGFyZyBvZiBhcmdzKSB7XG4gICAgaWYgKF8uaXNTdHJpbmcoYXJnKSAmJiBhcmcuc3RhcnRzV2l0aChJTUFHRV9FTEVNRU5UX1BSRUZJWCkpIHtcbiAgICAgIHJldHVybiBhcmc7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7XG4gIEltYWdlRWxlbWVudCwgZ2V0SW1nRWxGcm9tQXJncywgbWFrZUltYWdlRWxlbWVudENhY2hlLFxuICBJTUFHRV9FTF9UQVBfU1RSQVRFR1lfTUpTT05XUCwgSU1BR0VfRUxfVEFQX1NUUkFURUdZX1czQyxcbiAgREVGQVVMVF9URU1QTEFURV9JTUFHRV9TQ0FMRVxufTtcbiJdLCJmaWxlIjoibGliL2Jhc2Vkcml2ZXIvaW1hZ2UtZWxlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
